# Node coverage report

[![MIT License](https://img.shields.io/badge/license-MIT-brightgreen.svg)](https://github.com/huk10/node-coverage-report/blob/master/LICENSE)
[![Release](https://img.shields.io/github/release/huk10/node-coverage-report.svg?style=flat-square)](https://github.com/huk10/node-coverage-report/releases)

A GitHub Action to add a coverage [badge][badge] to your JavaScript repo. 
Part of the code comes from [go-coverage-report](https://github.com/ncruces/go-coverage-report).

## How works

At present, the mainstream testing framework of JavaScript should work with `istanbuljs` to generate coverage reports.
This Action will read the report contents of `text-summary` or `json-summary` output from [istanbul.js] [istanbul] and
use the ability provided by [shields.io][shields] to generate a badge and save it in the wiki of your repo.

- if you are using vitest, you need to add one of these two reporters to the `coverage.uploter` of vitest.config.ts.
- if you are using jest, you need to add one of these two reporters to the `coverageReporters` of jest.config.ts.
- other libraries that can cooperate with [nyc][nyc] should also be supported.

## Usage

Apply it to your repo by adding this step to one of your workflows:

```yaml
- name: Update coverage report
  uses: huk10/node-coverage-report@v1
```

Your repo needs to have a Wiki for the action to work, and workflows need to have read and write permissions to the
repo.

The action has 6 configuration options:

- `command`: *optional* a test command that should be able to output test coverage. Default: `npm run test:coverage`
- `coverage-dir`: *optional* test coverage file output directory. Default: `coverage`
- `output-dir`: *optional* custom output directory for the badge. By default, the wiki's root directory.
- `badge-style` *optional* coverage badge style, generated by [shields.io][shields].
  one of: `flat` (default), `flat-square`, `plastic`, `for-the-badge`, `social`
- `badge-title`: *optional* coverage badge title. Default: `coverage`
- `amend`: *optional* amend your Wiki, avoiding a series of "Update coverage" commits. Default: `false`

Also, consider:

- running this step _after_ your tests run
    - coverage will fail if any test fails, so you may skip it if they fail
- running it only once per commit
    - use a condition to avoid repeated matrix runs
- skipping it for PRs
    - PRs lack permission to update the Wiki,
      nor would you want unsubmitted PRs to do so
- allowing it to fail without failing the entire job
    - if tests pass, the problem might be with the action itself, not your code

Complete example:

```yaml
name: Node.js

on: [ push ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [ 20 ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      - uses: pnpm/action-setup@v3
        with:
          version: 8
      - name: Install dependencies
        run: pnpm install
      - name: Update coverage badge
        uses: huk10/node-coverage-report@v1
        with:
          amend: true
        if: |
          matrix.os == 'ubuntu-latest' && github.event_name == 'push'
        continue-on-error: true
```

The action generates [SVG badge][badge] and saves them as "hidden" files in your Wiki.

To add a coverage badge to your `README.md`, use this Markdown snippet:

```markdown
![](https://github.com/USER/REPO/wiki/coverage.svg)
```

[badge]: https://github.com/huk10/esdi/wiki/coverage.svg

[istanbul]: https://istanbul.js.org/docs/advanced/alternative-reporters

[shields]: https://shields.io

[nyc]: https://github.com/istanbuljs/nyc
